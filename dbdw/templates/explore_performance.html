{% extends "layout.html" %}
{% block title %}Explore genre{% endblock %}
{% block content %}

    <div class="row">
        <h2 id="rec_header" class="col-12 show-on-success">Choose your OWN concert! </h2>

        <p class="show-on-success col-12 text-justify lead">
            Take your time to listen to songs that match your preference and to the songs
            that are more out of your comfort zone.
            After listening to the playlist, you are asked to fill
            in a survey about your experience with the recommendations and the interface. Hover over the
            <i class="fas fa-question-circle text-muted"></i> icons to get an explanation on the user interface.</p>

        <div id="alertbox" class="d-none-soft col-12"></div>

        <div id="loadingDiv" class="mb-5 col-12 hide-on-success">
            <div id="hloading" class="text-center lead">
                <div class="spinner-border" role="status">
                  <span class="sr-only">Loading...</span>
                </div>
                Your recommendations are being generated.
            </div>
        </div>
    </div>

    <div class="mb-3 row">
        <div id="contour_viz" class="show-on-success col-sm-6" data-intro="In this graph, you can see how the
            songs that match your preference (blue dots) together with the songs that are more out of your bubble (green dots)
            relate to your music taste (orange outline). The graphs shows two features of the songs: energy (the excitement of the song)
            and valence (the positiveness of the song) for the 4 different sessions: Sing-Songwriter, Harpist, Pop musicican, and Jazz musician" data-step='3'>
            <span class="help" data-toggle="tooltip" data-placement="top" style="position:absolute;right:20px;top:20px;"
                  title="In this graph, you can see how the
            recommendations (blue dots)
            relate to your taste (orange outline) and the typical songs of the genre
            (green outline). The graphs shows two features of the songs: energy (the excitement of the song)
            and valence (the positiveness of the song).">
                <i class="fas fa-question-circle text-info"></i>
            </span>
        </div>

        <div id="contour_viz2" class="show-on-success col-sm-6"
             data-intro="This graphs shows two features of the songs: danceability (how danceable a song is)
             and acousticness (how acoustic a song is)">
            <span class="help" data-toggle="tooltip" data-placement="top"
                  style="position:absolute;right:20px;top:10px;"
                  title="This graph shows two features of the songs: danceability (how danceable a song is)
                  and acousticness (how acoustic a song is)">
                <i class="fas fa-question-circle text-info"></i>
            </span>
        </div>
    </div>

    <div class="row">
        <div class="col-sm-3 order-sm-1 show-on-success" id="playlist_block1"
             data-intro="This column represents the pre-selected playlist, which matches your preference the most."
             data-step='1'>
                    <br>
                    <button class="btn btn-block
                    show-on-success" id="perform_1"></button>
                    <div id="playlist1" class="playlist_new"></div>
        </div>

        <div class="col-sm-3 order-sm-2 show-on-success" id="playlist_block2">
            <br>
            <button class="btn btn-block
            show-on-success" id="perform_2"></button>
            <div id="playlist2" class="playlist_new"></div>
        </div>

        <div class="col-sm-3 order-sm-2  show-on-success" id="playlist_block3">
            <br>
            <button class="btn btn-block
            show-on-success" id="perform_3"></button>
            <div id="playlist3" class="playlist_new"></div>
        </div>

        <div class="col-sm-3 order-sm-2 show-on-success" id="playlist_block4">
            <br>
            <button class="btn btn-block
            show-on-success" id="perform_4"></button>
            <div id="playlist4" class="playlist_new"></div>
        </div>
    </div>
    <br>

    <div class="row">
        <div class="col-sm-3">
            <button class="show-on-success btn btn-secondary save_playlist" id="save_playlist1"
                    data-intro="If you'd like, you can save this playlist to your Spotify account." data-step='4'>
                <i class="fas fa-download"></i> Save this playlist to my Spotify
            </button>
        </div>

        <div class="col-sm-3">
            <button class="show-on-success btn btn-secondary save_playlist" id="save_playlist2">
                <i class="fas fa-download"></i> Save this playlist to my Spotify
            </button>
        </div>

        <div class="col-sm-3">
            <button class="show-on-success btn btn-secondary save_playlist" id="save_playlist3">
                <i class="fas fa-download"></i> Save this playlist to my Spotify
            </button>
        </div>

        <div class="col-sm-3">
            <button class="show-on-success btn btn-secondary save_playlist" id="save_playlist4"
                    data-intro="If you'd like, you can save this playlist to your Spotify account." data-step='5'>
                <i class="fas fa-download"></i> Save this playlist to my Spotify
            </button>
        </div>
    </div>
    <br>
    <div class="col-sm text-right">
        <a class="show-on-success btn btn-outline-success" id="continue" href="/save_selected_stream"
           data-intro="After selecting the performance you want to listen to during the concert, click the button to continue" data-step='6'>
            Continue <i class="fas fa-arrow-right"></i>
        </a>
    </div>

{% endblock %}

{% block scripts %}

    <script>

    let contour_plot;
    let user_mean_energy;
    let user_mean_valence;
    let visible_recommendations1,
        visible_recommendations2,
        visible_recommendations3,
        visible_recommendations4;

    let event1,
        event2,
        event3,
        event4;

    const circle = d3.symbol().type(d3.symbolCircle)(),
        triangleU = d3.symbol().type(d3.symbolTriangle)(),
        cross = d3.symbol().type(d3.symbolCross)(),
        diamond = d3.symbol().type(d3.symbolDiamond)(),
        star = d3.symbol().type(d3.symbolStar)();

    const circle_big = d3.symbol().size(200).type(d3.symbolCircle),
        triangleU_big = d3.symbol().size(200).type(d3.symbolTriangle),
        cross_big = d3.symbol().size(200).type(d3.symbolCross),
        diamond_big = d3.symbol().size(200).type(d3.symbolDiamond),
        star_big = d3.symbol().size(200).type(d3.symbolStar)

    const colors = {
        "user_profile": "#CB4335",
        "event1": "#8E44AD",
        "event1_highlight": "#7D3C98",
        "event2": "#2471A3",
        "event2_highlight": "#2E86C1",
        "event3": "#229954",
        "event3_highlight": "#28B463",
        "event4": "#D4AC0D",
        "event4_highlight": "#D68910",
        "playlist-background": "#ffffff00",
    };

    function fillPlaylist(){

        let $playlist1 = $("#playlist1");
        $playlist1
            .append($("<ul>"));
        let $playlist1_ul = $("#playlist1 ul");
        let i = 0;

        visible_recommendations1.forEach(function (track) {
            let iframe_suffix = i.toString();

            let $newElement = $("<li>").addClass("track")
                .append($("<iframe>").attr("id","iframe_spotify" + iframe_suffix)
                    .attr("src", "https://open.spotify.com/embed/track/" + track.id)
                    .attr("width", "100%")
                    .attr("height", "80")
                    .attr("frameborder", "0")
                    .attr("allowtransparency", "true")
                    .attr("allow", "encrypted-media"))
                .append($("<span>").attr("value", track.id).addClass("trackid"));

            $playlist1_ul.append($newElement);
            ++i;
        });

        let $playlist2 = $("#playlist2");
        $playlist2
            .append($("<ul>"));
        let $playlist2_ul = $("#playlist2 ul");

        visible_recommendations2.forEach(function (track) {
            let iframe_suffix = i.toString();

            let $newElement = $("<li>").addClass("track")
                .append($("<iframe>").attr("id","iframe_spotify" + iframe_suffix)
                    .attr("src", "https://open.spotify.com/embed/track/" + track.id)
                    .attr("width", "100%")
                    .attr("height", "80")
                    .attr("frameborder", "0")
                    .attr("allowtransparency", "true")
                    .attr("allow", "encrypted-media"))
                .append($("<span>").attr("value", track.id).addClass("trackid"));

            $playlist2_ul.append($newElement);
            ++i;
        });


        let $playlist3 = $("#playlist3");
        $playlist3
            .append($("<ul>"));
        let $playlist3_ul = $("#playlist3 ul");

        visible_recommendations3.forEach(function (track) {
            let iframe_suffix = i.toString();

            let $newElement = $("<li>").addClass("track")
                .append($("<iframe>").attr("id","iframe_spotify" + iframe_suffix)
                    .attr("src", "https://open.spotify.com/embed/track/" + track.id)
                    .attr("width", "100%")
                    .attr("height", "80")
                    .attr("frameborder", "0")
                    .attr("allowtransparency", "true")
                    .attr("allow", "encrypted-media"))
                .append($("<span>").attr("value", track.id).addClass("trackid"));

            $playlist3_ul.append($newElement);
            ++i;
        });


        let $playlist4 = $("#playlist4");
        $playlist4
            .append($("<ul>"));
        let $playlist4_ul = $("#playlist4 ul");

        visible_recommendations4.forEach(function (track) {
            let iframe_suffix = i.toString();

            let $newElement = $("<li>").addClass("track")
                .append($("<iframe>").attr("id","iframe_spotify" + iframe_suffix)
                    .attr("src", "https://open.spotify.com/embed/track/" + track.id)
                    .attr("width", "100%")
                    .attr("height", "80")
                    .attr("frameborder", "0")
                    .attr("allowtransparency", "true")
                    .attr("allow", "encrypted-media"))
                .append($("<span>").attr("value", track.id).addClass("trackid"));

            $playlist4_ul.append($newElement);
            ++i;
        });
    }

    $(function () {
        // Save playlist to Spotify
        $('.save_playlist').on('click', function()  {
            let trackString = "";
            let playlistname;
            if ($(this).attr("id") === "save_playlist1"){
                for (let i = 0; i < visible_recommendations1.length; i++) {
                    trackString = trackString + "," + visible_recommendations1[i].id;
                }
                playlistname = "DBDW: " + event1

            }else if ($(this).attr("id") === "save_playlist2"){
                for (let i = 0; i < visible_recommendations2.length; i++) {
                    trackString = trackString + "," + visible_recommendations2[i].id;
                }
                playlistname = "DBDW: " + event2

            }else if ($(this).attr("id") === "save_playlist3"){
                for (let i = 0; i < visible_recommendations3.length; i++) {
                    trackString = trackString + "," + visible_recommendations3[i].id;
                }
                playlistname = "DBDW: " + event3

            }else{
                for (let i = 0; i < visible_recommendations4.length; i++) {
                    trackString = trackString + "," + visible_recommendations4[i].id;
                }
                playlistname = "DBDW: " + event4
            }

            $.ajax({
                url: "/generate_playlist_spotify/" + playlistname + "?tracks=" + trackString.substring(1,) + "",
                global: false
            }).done(function (data){
                if (data === "done"){
                    alert("Your playlist has been successfully saved to your Spotify account");
                    $("#save_playlist")
                        .hover().css("opacity", 1)
                        .css("cursor", "auto");
                } else{
                    alert("Please try again");
                }
            });
        });

        // Highlight point in scatter plot when user hovers over track
        $(".playlist_new")
            .on("mouseover", ".track", function() {
                let track_id = $(this).children(".trackid").attr("value");
                let point = $(".rec_scatter [data-track-id=" + track_id + "]");

                if (point.attr("shape_text") === "star"){
                    point.attr("d", star_big);
                }
                else if (point.attr("shape_text") === "triangle"){
                    point.attr("d", triangleU_big);
                }else if (point.attr("shape_text") === "cross"){
                    point.attr("d", cross_big);
                }else if (point.attr("shape_text") === "diamond"){
                    point.attr("d", diamond_big);
                }
            })
            .on("mouseout", ".track", function() {
                let track_id = $(this).children(".trackid").attr("value");
                let point = $(".rec_scatter [data-track-id=" + track_id + "]");

                if (point.attr("shape_text") === "star"){
                    point.attr("d", star);
                }else if (point.attr("shape_text") === "triangle"){
                    point.attr("d", triangleU);
                }else if (point.attr("shape_text") === "cross"){
                    point.attr("d", cross);
                }else if (point.attr("shape_text") === "diamond"){
                    point.attr("d", diamond);
                }
            });
    });


    /* Contour plot visualisation ------------------------------------------------------------------------------------*/
    function ContourPlot(contour_viz, user_top_tracks, feature1, feature2)
    {
        this.contour_viz = contour_viz;
        this.user_top_tracks = user_top_tracks;
        this.feature1 = feature1;
        this.feature2 = feature2;

        // set the dimensions and margins of the graph
        const margin = {top: 20, right: 120, bottom: 30, left: 120},
            width = 540 - margin.left - margin.right,
            height = 400 - margin.top - margin.bottom;

        // append the svg object to the body of the page
        this.svg = d3.select(contour_viz)
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

        // Add X axis
        let x = d3.scaleLinear()
            .domain([0, 1])
            .range([ 0, width ]);
        this.svg.append("g")
            .attr("transform", "translate(0," + height/2 + ")")
            .attr("opacity", ".5")
            .call(d3.axisBottom(x).tickValues([]).tickSizeOuter(0));

        // Add Y axis
        let y = d3.scaleLinear()
            .domain([0, 1])
            .range([ height, 0 ]);
        this.svg.append("g")
            .attr("transform", "translate(" + width/2 + ", 0)")
            .attr("opacity", ".5")
            .call(d3.axisLeft(y).tickValues([]).tickSizeOuter(0));

        let compute_density_estimate;

        compute_density_estimate = data => {
            return d3.contourDensity()
                .x(function(d) { return x(d[feature1]); })   // x and y = column name in input data
                .y(function(d) { return y(d[feature2]); })
                .size([width, height])
                .bandwidth(25)    // smaller = more precision in lines = more lines
                (data);
        };

        // compute the density data for genre and user profile
        let user_density = compute_density_estimate(this.user_top_tracks);

        let opacity_scale = (density_estimate) => {
            return d3.scalePow()
                .exponent(2)
                .domain(d3.extent(density_estimate, d => d.value)) // Points per square pixel.
                .range([0, 1]);
        };


        this.add_contour_plot = (density_estimate, color) => {
            this.svg.append("g")
                .selectAll("path")
                .data(density_estimate)
                    .enter()
                    .append("path")
                    .attr("d", d3.geoPath())
                    .attr("fill", "none")
                    .attr("stroke", color)
                    .attr("stroke-opacity", d => opacity_scale(density_estimate)(d.value))
                    .attr("stroke-linejoin", "round");
        };

        // Add the contour plot for the genre
        this.add_contour_plot(user_density, colors.user_profile);

        this.add_scatter_plot = (data, color, shape, shape_big, shape_text, classname) => {
            this.svg.append("g")
                .attr("class", classname)
                .attr("stroke", "white")
                .attr("fill", color)
                .selectAll("path")
                .data(data)
                    .enter().append("path")
                    .attr("transform", function(d) { return "translate(" + x(d[feature1]) + "," + y(d[feature2]) + ")"; })
                    .attr("data-track-id", d => d.id)
                    .attr("d", shape)
                    .attr("shape_text", shape_text)
                .on('mouseover',function(d) {
                    d3.select(this)
                        .attr('d', shape_big);
                    let current_track = $(".trackid[value=" + d.id + "]");
                    if (current_track.parent().parent().parent().parent().attr("id") === "playlist_block1"){
                        current_track.parent().addClass("track--highlighted-1");
                    }else if (current_track.parent().parent().parent().parent().attr("id") === "playlist_block2"){
                        current_track.parent().addClass("track--highlighted-2");
                    }else if (current_track.parent().parent().parent().parent().attr("id") === "playlist_block3"){
                        current_track.parent().addClass("track--highlighted-3");
                    }else{
                        current_track.parent().addClass("track--highlighted-4");
                    }

                })
                .on('mouseout',function(d) {
                    d3.select(this)
                        .attr('d', shape);

                    let current_track = $(".trackid[value=" + d.id + "]");
                    if (current_track.parent().parent().parent().parent().attr("id") === "playlist_block1"){
                        current_track.parent().removeClass("track--highlighted-1");
                    }else if (current_track.parent().parent().parent().parent().attr("id") === "playlist_block2"){
                        current_track.parent().removeClass("track--highlighted-2");
                    }else if (current_track.parent().parent().parent().parent().attr("id") === "playlist_block3"){
                        current_track.parent().removeClass("track--highlighted-3");
                    }else{
                        current_track.parent().removeClass("track--highlighted-4");
                    }

                })
        };


        this.remove_group = (selector) => {
            this.svg.selectAll(selector).remove();
         };


        // Add a scatter plot for the recommendations1
        this.add_scatter_plot(visible_recommendations1, colors.event1, star,
            star_big, "star", "rec_scatter");
        this.add_scatter_plot(visible_recommendations2, colors.event2, triangleU,
            triangleU_big, "triangle", "rec_scatter");
        this.add_scatter_plot(visible_recommendations3, colors.event3, cross,
            cross_big, "cross", "rec_scatter");
        this.add_scatter_plot(visible_recommendations4, colors.event4, diamond,
            diamond_big, "diamond", "rec_scatter");

        let x_negative;
        let x_positive;
        let y_negative;
        let y_positive;

        switch (feature1) {
            case "valence":
                x_negative = "Negative";
                x_positive = "Positive";
                break;
            case "energy":
                x_negative = "Calming";
                x_positive = "Exciting";
                break;
            case "danceability":
                x_negative = "Less danceable";
                x_positive = "More danceable";
                break;
            case "acousticness":
                x_negative = "Less acoustic";
                x_positive = "More acoustic";
                break;
        }

        switch (feature2) {
            case "valence":
                y_negative = "Negative";
                y_positive = "Positive";
                break;
            case "energy":
                y_negative = "Calming";
                y_positive = "Exciting";
                break;
            case "danceability":
                y_negative = "Less danceable";
                y_positive = "More danceable";
                break;
            case "acousticness":
                y_negative = "Less acoustic";
                y_positive = "More acoustic";
                break;
        }

        // Add labels
        this.svg.append("text")
            .attr("class", "x label")
            .attr("text-anchor", "end")
            .attr("alignment-baseline", "central")
            .attr("x", -1)
            .attr("y", height/2)
            .text(x_negative);
        this.svg.append("text")
            .attr("class", "x label")
            .attr("text-anchor", "start")
            .attr("alignment-baseline", "central")
            .attr("x", width+1)
            .attr("y", height/2)
            .text(x_positive);
        this.svg.append("text")
            .attr("class", "y label")
            .attr("text-anchor", "middle")
            .attr("x", width/2)
            .attr("y", -1)
            .text(y_positive);
        this.svg.append("text")
            .attr("class", "y label")
            .attr("text-anchor", "middle")
            .attr("alignment-baseline", "hanging")
            .attr("x", width/2)
            .attr("y", height+1)
            .text(y_negative);

        let symbolScale =  d3.scaleOrdinal()
            .domain(["Your taste", event1, event2, event3, event4])
            .range([circle, star, triangleU, cross, diamond] );

        let colorScale =  d3.scaleOrdinal()
            .domain(["Your taste", event1, event2, event3, event4])
            .range([colors.user_profile, colors.event1, colors.event2, colors.event3, colors.event4] );

        this.svg.append("g")
            .attr("class", "legendSymbol")
            .attr("transform", "translate(-75, 0)");
            //.attr("transform", "translate(270, 300)");

        let legendPath = d3.legendSymbol()
            .scale(symbolScale)
            .shapePadding(16);

        this.svg.select(".legendSymbol")
            .call(legendPath);

        this.svg.selectAll(".cell path").each(function(d) {
            d3.select(this).style("fill", colorScale(d))
        })
    }

    /* Guided tour ---------------------------------------------------------------------------------------------------*/
    // Instance the tour
    let introJsObj = introJs();
    introJsObj.onexit(function() {
        $(".make-sticky-later").addClass("sticky");
    });
    introJsObj.setOptions({
        'exitOnOverlayClick': false,
        'disableInteraction': true
    });

    /* Enable tooltips -----------------------------------------------------------------------------------------------*/
    $(function () {
        $('[data-toggle="tooltip"]').tooltip();
    });


    /* Read data -----------------------------------------------------------------------------------------------------*/
    Promise.all([
        d3.json("/event_recommendation/performance"),
        d3.json("/user_top_tracks"),
    ]).then(function(data) {
        // Extract data from promises
        let recommendations = data[0],
            user_top_tracks = data[1];

        user_mean_energy = mean(user_top_tracks, "energy");
        user_mean_valence = mean(user_top_tracks, "valence");

        function mean(tracks, attribute) {
            let sum = 0.0;
            for(let i = 0; i < tracks.length; i++ ){
                sum += tracks[i][attribute];
            }
            return sum/tracks.length;
        }

        // Initialise playlist and visualisation
        visible_recommendations1 = recommendations[0].tracks;
        visible_recommendations2 = recommendations[1].tracks;
        visible_recommendations3 = recommendations[2].tracks;
        visible_recommendations4 = recommendations[3].tracks;
        event1 = recommendations[0].event;
        event2 = recommendations[1].event;
        event3 = recommendations[2].event;
        event4 = recommendations[3].event;

        $("#perform_1").html("More matching your preferences: " + event1);
        $("#perform_2").html(event2);
        $("#perform_3").html(event3);
        $("#perform_4").html("More out of your bubbles: <br>" + event4);

        $('#perform_1').click(function () {
            $('#playlist_block1').css("background-color", colors.event1_highlight);
            $('#playlist_block2').css("background-color", colors["playlist-background"]);
            $('#playlist_block3').css("background-color", colors["playlist-background"]);
            $('#playlist_block4').css("background-color", colors["playlist-background"]);

            $('#continue').attr('href', '/save_selected_stream?stream=' + event1);
        });

        $('#perform_2').click(function () {
            $('#playlist_block1').css("background-color", colors["playlist-background"]);
            $('#playlist_block2').css("background-color", colors.event2_highlight);
            $('#playlist_block3').css("background-color", colors["playlist-background"]);
            $('#playlist_block4').css("background-color", colors["playlist-background"]);
            $('#continue').attr('href', '/save_selected_stream?stream=' + event2);
        });

        $('#perform_3').click(function () {
            $('#playlist_block1').css("background-color", colors["playlist-background"]);
            $('#playlist_block2').css("background-color", colors["playlist-background"]);
            $('#playlist_block3').css("background-color", colors.event3_highlight);
            $('#playlist_block4').css("background-color", colors["playlist-background"]);
            $('#continue').attr('href', '/save_selected_stream?stream=' + event3);
        });

        $('#perform_4').click(function () {
            $('#playlist_block1').css("background-color", colors["playlist-background"]);
            $('#playlist_block2').css("background-color", colors["playlist-background"]);
            $('#playlist_block3').css("background-color", colors["playlist-background"]);
            $('#playlist_block4').css("background-color", colors.event4_highlight);
            $('#continue').attr('href', '/save_selected_stream?stream=' + event4);
        });

        fillPlaylist();

        contour_plot = new ContourPlot("#contour_viz", user_top_tracks, "valence", "energy");
        contour_plot2 = new ContourPlot("#contour_viz2", user_top_tracks, "acousticness", "danceability");

        // Hide loading indicator and show results
        $('.hide-on-success').hide();
        $('.show-on-success').show();

        // Initialise and start the tour
        introJsObj.start();

    }).catch(function(e) {
        // Display error message in console
        console.error(e);

        // Show error message in #hloading box
        $('#hloading').text(e.message);
    });

    </script>
{% endblock %}
